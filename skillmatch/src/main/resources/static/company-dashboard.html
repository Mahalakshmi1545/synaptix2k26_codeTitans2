<!DOCTYPE html>
<html>
<head>
    <title>Company Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand fw-bold" href="#">
        SkillMatcher
    </a>

	<div class="ms-auto">
        <a href="company-register.html"
           class="btn btn-outline-light me-2">
           Register
        </a>

        <a href="company-login.html"
           class="btn btn-outline-light me-2">
           Login
        </a>
		<button class="btn btn-danger"
			                onclick="logout()">
			            Logout
			        </button>
		    

        
    </div>
</nav>

<div class="container mt-5">

    <h3 class="mb-4">Company Dashboard</h3>

    <!-- ================= ADD PROJECT ================= -->
    <div class="card p-4 shadow mb-4">
        <h5>Add Project</h5>

        <input type="text" id="title" class="form-control mb-2" placeholder="Project Title">
        <input type="text" id="skills" class="form-control mb-2" placeholder="Required Skills">
        <input type="number" id="experience" class="form-control mb-2" placeholder="Minimum Experience">

        <button class="btn btn-success w-100" onclick="addProject()">Add Project</button>
    </div>

    <!-- ================= PROJECT LIST ================= -->
    <div class="card p-4 shadow mb-4">
        <h5>My Projects</h5>

        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="projectsBody"></tbody>
        </table>
    </div>

    <!-- ================= RANKING SECTION ================= -->
    <div class="card p-4 shadow">

        <h5>Ranking Results</h5>

        <h6 class="mb-3">
            Ranking For Project:
            <span id="rankingProjectName" class="text-primary"></span>
        </h6>

        <!-- Filter -->
        <div class="row mb-3">
            <div class="col-md-8">
                <input type="number" id="scoreFilter"
                       class="form-control"
                       placeholder="Enter minimum score (0-100)">
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100"
                        onclick="applyFilter()">
                    Apply Filter
                </button>
            </div>
        </div>

        <p><strong>Total Candidates:</strong>
           <span id="candidateCount">0</span>
        </p>

        <table class="table table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Candidate</th>
                    <th>Score</th>
                    <th>Explanation</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Candidate Details Modal -->
<div class="modal fade" id="candidateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Candidate Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Name:</strong> <span id="modalName"></span></p>
        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
        <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
        <p><strong>Location:</strong> <span id="modalLocation"></span></p>
        <p><strong>Skills:</strong> <span id="modalSkills"></span></p>
        <p><strong>Experience:</strong> <span id="modalExperience"></span> years</p>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

let currentProjectId = null;
let currentProjectTitle = "";

const companyEmail = localStorage.getItem("companyEmail");

if (!companyEmail) {
    window.location.href = "company-login.html";
}

function logout() {
    localStorage.clear();
    window.location.href = "home.html";
}

function applyFilter() {
    if (currentProjectId !== null) {
        loadRanking(currentProjectId);
    }
}

/* ================= LOAD PROJECTS ================= */

function loadProjects() {
    fetch("/projects/company/" + companyEmail)
    .then(res => res.json())
    .then(data => {

        const body = document.getElementById("projectsBody");
        body.innerHTML = "";

        data.forEach(project => {
            body.innerHTML += `
                <tr>
                    <td>${project.title}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-2"
                                onclick="loadRanking(${project.id}, '${project.title}')">
                            View Ranking
                        </button>

                        <button class="btn btn-warning btn-sm me-2"
                                onclick="editProject(${project.id}, '${project.title}', '${project.requiredSkills}', ${project.minExperience})">
                            Edit
                        </button>

                        <button class="btn btn-danger btn-sm"
                                onclick="deleteProject(${project.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        });
    });
}
/* ================= LOAD RANKING ================= */

function loadRanking(projectId, projectTitle) {

    currentProjectId = projectId;

    // Only update title if passed
    if (projectTitle !== undefined) {
        currentProjectTitle = projectTitle;
    }

    document.getElementById("rankingProjectName").innerText = currentProjectTitle;

    fetch("/match/" + projectId)
    .then(res => res.json())
    .then(data => {

        const body = document.getElementById("resultsBody");
        body.innerHTML = "";

        // IMPORTANT: Get filter value HERE
        let minScoreInput = document.getElementById("scoreFilter").value;
        let minScore = minScoreInput ? parseFloat(minScoreInput) : 0;

        const filtered = data.filter(result => result.score >= minScore);

        document.getElementById("candidateCount").innerText = filtered.length;

        if (filtered.length === 0) {
            body.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">
                        No candidates found.
                    </td>
                </tr>
            `;
            return;
        }

        filtered.forEach((result, index) => {

            let highlight = index === 0 ? "table-success" : "";

            body.innerHTML += `
                <tr class="${highlight}">
                    <td>
                        <a href="#" onclick="viewCandidate(${result.candidateId})">
                            ${result.candidateName}
                        </a>
                        ${index === 0 ? '<span class="badge bg-success ms-2">Top</span>' : ''}
                    </td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-success"
                                 style="width: ${result.score}%;">
                                ${result.score.toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td>${result.explanation}</td>
					<td>
					    ${
					        result.selected
					        ? `<button class="btn btn-secondary btn-sm" disabled>
					                Selected
					           </button>`
					        : `<button class="btn btn-success btn-sm"
					                onclick="selectCandidate(${result.candidateId}, ${projectId}, this)">
					                Select
					           </button>`
					    }
					</td>
                </tr>
            `;
        });

    });
}/* ================= SELECT ================= */
function selectCandidate(candidateId, projectId) {

    const selection = {
        candidateId: candidateId,
        projectId: projectId,
        companyEmail: companyEmail
    };

    fetch("/projects/select", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(selection)
    })
    .then(res => res.text())
    .then(() => {
        loadRanking(projectId);
    });
}/* ================= DELETE ================= */

function deleteProject(projectId) {

    if (!confirm("Delete this project?")) return;

    fetch("/projects/delete/" + projectId, {
        method: "DELETE"
    })
    .then(res => res.text())
    .then(() => {
        loadProjects();
        document.getElementById("resultsBody").innerHTML = "";
        document.getElementById("rankingProjectName").innerText = "";
        document.getElementById("candidateCount").innerText = "0";
    });
}

/* ================= VIEW DETAILS ================= */

function viewCandidate(id) {

    fetch("/candidates/details/" + id)
    .then(res => res.json())
    .then(data => {

        document.getElementById("modalName").innerText = data.name;
        document.getElementById("modalEmail").innerText = data.email;
        document.getElementById("modalPhone").innerText = data.phone;
        document.getElementById("modalLocation").innerText = data.location;
        document.getElementById("modalSkills").innerText = data.skills;
        document.getElementById("modalExperience").innerText = data.experience;

        new bootstrap.Modal(document.getElementById('candidateModal')).show();
    });
}
function editProject(id, title, skills, experience) {

    document.getElementById("editProjectId").value = id;
    document.getElementById("editTitle").value = title;
    document.getElementById("editSkills").value = skills;
    document.getElementById("editExperience").value = experience;

    const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
    modal.show();
}

function updateProject() {

    const id = document.getElementById("editProjectId").value;

    const updatedData = {
        title: document.getElementById("editTitle").value,
        requiredSkills: document.getElementById("editSkills").value,
        minExperience: parseInt(document.getElementById("editExperience").value)
    };

    fetch("/projects/update/" + id, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(updatedData)
    })
    .then(res => res.text())
    .then(msg => {

        // ðŸ”¥ Close modal properly
        const modalElement = document.getElementById('editProjectModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        modalInstance.hide();

        alert(msg);

        loadProjects();
    });
}
loadProjects();

</script>
<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editProjectId">

        <input type="text" id="editTitle" class="form-control mb-2" placeholder="Project Title">
        <input type="text" id="editSkills" class="form-control mb-2" placeholder="Required Skills">
        <input type="number" id="editExperience" class="form-control mb-2" placeholder="Minimum Experience">

        <button class="btn btn-success w-100" onclick="updateProject()">Save Changes</button>
      </div>

    </div>
  </div>
</div>
</body>
</html>